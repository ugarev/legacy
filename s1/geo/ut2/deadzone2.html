<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dead Zone: Adventure Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Cinematic UI */
        #ui-layer {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        #subtitle-box {
            background: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,0.8), rgba(0,0,0,0));
            color: #ffeb3b; /* Yellow text for adventure feel */
            text-shadow: 0 2px 4px rgba(0,0,0,1);
            padding: 15px 50px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 1px;
            transition: opacity 0.5s;
        }

        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a237e, #000);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        h1 { margin: 0 0 10px 0; color: #fff; font-size: 3rem; text-transform: uppercase; letter-spacing: 3px; }
        p { color: #4fc3f7; margin-bottom: 40px; font-size: 1.2rem; }

        button {
            padding: 20px 60px;
            font-size: 1.5rem;
            font-weight: 800;
            background: #ffeb3b;
            color: #000;
            border: none;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
        }
        button:hover { transform: scale(1.05); background: #fff; }

        /* Status Labels */
        .label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffeb3b;
            color: #ffeb3b;
            padding: 8px 16px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>
    
    <div id="ui-layer">
        <div id="subtitle-box"></div>
    </div>

    <div id="start-overlay">
        <h1>Dead Zone</h1>
        <p>Cinematic Educational Experience</p>
        <button id="start-btn">BEGIN MISSION</button>
    </div>

    <!-- Labels -->
    <div id="label-fertilizer" class="label">ALERT: TOXIC RUNOFF</div>
    <div id="label-eutrophication" class="label">DETECTED: EUTROPHICATION</div>
    <div id="label-bloom" class="label">WARNING: ALGAL BLOOM</div>
    <div id="label-block" class="label">LIGHT LEVELS: CRITICAL</div>
    <div id="label-deadzone" class="label" style="background:red; color:white; border-color:white;">DANGER: OXYGEN DEPLETED</div>

    <script>
        // --- 1. WEB AUDIO API SYNTHESIZER (Adventure Music) ---
        let audioCtx;
        let isPlayingMusic = false;
        let noteIndex = 0;
        let nextNoteTime = 0;
        const tempo = 130; // Fast, exciting tempo
        const lookahead = 25.0;
        const scheduleAheadTime = 0.1;

        // Bassline (Driving rhythm)
        const bassLine = [
            { note: 36, len: 0.25 }, { note: 36, len: 0.25 }, { note: 48, len: 0.25 }, { note: 36, len: 0.25 },
            { note: 39, len: 0.25 }, { note: 36, len: 0.25 }, { note: 43, len: 0.25 }, { note: 41, len: 0.25 }
        ];

        // Arpeggio (Adventure feel)
        const arpLine = [
            60, 63, 67, 72, 67, 63, 60, 55,
            58, 61, 65, 70, 65, 61, 58, 53
        ];

        function playNote(freq, time, duration, type = 'sawtooth', vol = 0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.value = freq;
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(time);
            
            // Envelope
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(vol, time + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration);
            
            osc.stop(time + duration);
        }

        function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(noteIndex, nextNoteTime);
                nextNote();
            }
            if (isPlayingMusic) window.setTimeout(scheduler, lookahead);
        }

        function scheduleNote(beatNumber, time) {
            const secondsPerBeat = 60.0 / tempo;
            
            // Bass (Every 16th note)
            const bassNote = bassLine[beatNumber % 8];
            playNote(midiToFreq(bassNote.note), time, 0.15, 'sawtooth', 0.15);
            
            // High Arp (Every 8th note)
            if (beatNumber % 2 === 0) {
                const arpNote = arpLine[(beatNumber / 2) % 16];
                playNote(midiToFreq(arpNote), time, 0.1, 'square', 0.03);
            }

            // "Drums" (Noise bursts)
            if (beatNumber % 4 === 0) { // Kickish
                 playNote(50, time, 0.05, 'sine', 0.4);
            }
            if ((beatNumber + 4) % 8 === 0) { // Snareish
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(100, time);
                osc.type = 'triangle';
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(time);
                gain.gain.setValueAtTime(0.2, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                osc.stop(time + 0.05);
            }
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / tempo;
            nextNoteTime += 0.25 * secondsPerBeat; // 16th notes
            noteIndex++;
        }

        function startMusic() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            isPlayingMusic = true;
            noteIndex = 0;
            nextNoteTime = audioCtx.currentTime;
            scheduler();
        }


        // --- 2. THREE.JS SCENE (Visuals) ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x051329); // Darker blue for drama
        scene.fog = new THREE.Fog(0x051329, 10, 100);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Dramatic Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffaa00, 1.5); // Golden hour / dramatic
        sunLight.position.set(50, 50, 20);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- ASSETS ---
        
        // Land
        const land = new THREE.Mesh(
            new THREE.BoxGeometry(50, 20, 50),
            new THREE.MeshPhongMaterial({ color: 0x5d4037 }) // Darker earth
        );
        land.position.set(-25, 0, 0);
        land.rotation.z = -0.2;
        land.receiveShadow = true;
        scene.add(land);

        // Ocean
        const ocean = new THREE.Mesh(
            new THREE.BoxGeometry(80, 18, 50),
            new THREE.MeshPhongMaterial({ color: 0x01579b, transparent: true, opacity: 0.7, shininess: 100 })
        );
        ocean.position.set(30, -5, 0);
        scene.add(ocean);

        // Algae (Hidden)
        const algae = new THREE.Mesh(
            new THREE.PlaneGeometry(80, 50),
            new THREE.MeshBasicMaterial({ color: 0x76ff03, transparent: true, opacity: 0, side: THREE.DoubleSide })
        );
        algae.rotation.x = -Math.PI/2;
        algae.position.y = 4.1;
        ocean.add(algae);

        // Fish Generator (Realistic-ish)
        function createFish() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.ConeGeometry(0.5, 2, 8), new THREE.MeshPhongMaterial({ color: 0xff9800 }));
            body.rotation.z = -Math.PI/2;
            const tail = new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.8, 8), new THREE.MeshPhongMaterial({ color: 0xff9800 }));
            tail.rotation.z = Math.PI/2; tail.position.x = -1.2;
            group.add(body); group.add(tail);
            return group;
        }

        const fishArray = [];
        for(let i=0; i<12; i++){
            const f = createFish();
            f.position.set(10 + Math.random()*40, -5 + Math.random()*8, (Math.random()-0.5)*30);
            f.userData = { speed: 0.05 + Math.random()*0.1, dir: 1, dead: false };
            scene.add(f);
            fishArray.push(f);
        }

        // Particles (Fertilizer)
        const partGeo = new THREE.BufferGeometry();
        const partCount = 300;
        const partPos = new Float32Array(partCount * 3);
        const partMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.4 });
        const particles = new THREE.Points(partGeo, partMat);
        particles.visible = false;
        scene.add(particles);

        // --- ANIMATION LOGIC ---

        const STATE = {
            runoff: false,
            bloom: false,
            dark: false,
            death: false
        };

        const steps = [
            {
                text: "MISSION START: Observe the coastline ecosystem.",
                duration: 4000,
                cam: { pos: new THREE.Vector3(-20, 25, 40), look: new THREE.Vector3(10, 0, 0) },
                action: null,
                label: null
            },
            {
                text: "DETECTED: Intensive farming using excessive chemical fertilizers.",
                duration: 5000,
                cam: { pos: new THREE.Vector3(-25, 15, 10), look: new THREE.Vector3(-25, 10, 0) },
                action: () => { STATE.runoff = true; particles.visible = true; },
                label: 'label-fertilizer'
            },
            {
                text: "TRACKING: Chemicals washing into the ocean via groundwater flow.",
                duration: 5000,
                cam: { pos: new THREE.Vector3(0, 5, 30), look: new THREE.Vector3(0, 0, 0) },
                action: null,
                label: null
            },
            {
                text: "ALERT: Nutrient levels critical! Eutrophication in progress.",
                duration: 5000,
                cam: { pos: new THREE.Vector3(20, 15, 20), look: new THREE.Vector3(20, 0, 0) },
                action: () => { document.getElementById('label-eutrophication').style.opacity = 1; },
                label: 'label-eutrophication'
            },
            {
                text: "VISUAL CONFIRMATION: Explosive Algal Bloom blocking surface.",
                duration: 5000,
                cam: { pos: new THREE.Vector3(30, 10, 30), look: new THREE.Vector3(30, 4, 0) },
                action: () => { STATE.bloom = true; },
                label: 'label-bloom'
            },
            {
                text: "STATUS: Sunlight blocked. Deep water entering darkness.",
                duration: 5000,
                cam: { pos: new THREE.Vector3(30, -5, 20), look: new THREE.Vector3(30, -5, 0) },
                action: () => { STATE.dark = true; },
                label: 'label-block'
            },
            {
                text: "ANALYSIS: Oxygen levels dropping rapidly due to decomposition.",
                duration: 5000,
                cam: { pos: new THREE.Vector3(30, -10, 10), look: new THREE.Vector3(30, -5, 0) },
                action: null,
                label: null
            },
            {
                text: "CATASTROPHE IMMINENT: Marine life cannot sustain respiration.",
                duration: 4000,
                cam: { pos: new THREE.Vector3(30, -5, 15), look: new THREE.Vector3(30, -5, 0) },
                action: null,
                label: null
            },
            {
                text: "FINAL STATUS: Ecosystem collapse. DEAD ZONE ESTABLISHED.",
                duration: 8000,
                cam: { pos: new THREE.Vector3(0, 50, 0), look: new THREE.Vector3(20, 0, 0) },
                action: () => { STATE.death = true; },
                label: 'label-deadzone'
            }
        ];

        let currentStep = 0;
        let targetPos = steps[0].cam.pos;
        let targetLook = steps[0].cam.look;
        const subBox = document.getElementById('subtitle-box');

        function runSequence() {
            if(currentStep >= steps.length) {
                subBox.innerText = "MISSION FAILED: ECOSYSTEM LOST";
                return;
            }

            const s = steps[currentStep];
            
            // Text Update
            subBox.style.opacity = 0;
            setTimeout(() => {
                subBox.innerText = s.text;
                subBox.style.opacity = 1;
            }, 500);

            // Cam Update
            targetPos = s.cam.pos;
            targetLook = s.cam.look;

            // Trigger Actions
            if(s.action) s.action();
            
            // Labels
            document.querySelectorAll('.label').forEach(l => l.style.opacity = 0);
            if(s.label) {
                const l = document.getElementById(s.label);
                l.style.opacity = 1;
                l.style.left = '50%'; l.style.top = '20%'; // Simple centering
            }

            currentStep++;
            setTimeout(runSequence, s.duration);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Camera LERP
            camera.position.lerp(targetPos, 0.02);
            if(!camera.userData.currLook) camera.userData.currLook = targetLook.clone();
            camera.userData.currLook.lerp(targetLook, 0.02);
            camera.lookAt(camera.userData.currLook);

            // Visual FX
            if(STATE.runoff) {
                const pos = partGeo.attributes.position ? partGeo.attributes.position.array : partPos;
                for(let i=0; i<partCount; i++) {
                    if(pos[i*3]==0) { // Init
                        pos[i*3] = -25 + (Math.random()-0.5)*15;
                        pos[i*3+1] = 10 + Math.random()*5;
                        pos[i*3+2] = (Math.random()-0.5)*20;
                    }
                    if(pos[i*3+1] > 0) { // Fall
                        pos[i*3+1] -= 0.2; pos[i*3] += 0.1;
                    } else { // Flow
                        pos[i*3] += 0.3;
                    }
                    if(pos[i*3] > 10) pos[i*3] = -25 + (Math.random()-0.5)*5; // Reset
                }
                partGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
                partGeo.attributes.position.needsUpdate = true;
            }

            if(STATE.bloom) {
                algae.material.opacity = Math.min(algae.material.opacity + 0.005, 0.9);
                ocean.material.color.lerp(new THREE.Color(0x004d40), 0.01);
            }

            if(STATE.dark) {
                sunLight.intensity = Math.max(0.1, sunLight.intensity - 0.01);
                ambientLight.intensity = Math.max(0.1, ambientLight.intensity - 0.01);
                scene.fog.color.lerp(new THREE.Color(0x000000), 0.01);
                scene.background.lerp(new THREE.Color(0x000000), 0.01);
            }

            // Fish
            fishArray.forEach(f => {
                if(STATE.death) {
                   if(!f.userData.dead) f.userData.dead = true;
                   f.rotation.z = Math.min(f.rotation.z + 0.1, Math.PI); // Flip
                   f.position.y = Math.min(f.position.y + 0.02, 2); // Float
                } else {
                   f.position.x += f.userData.speed * f.userData.dir;
                   // Wiggle
                   f.children[1].rotation.z = (Math.PI/2) + Math.sin(Date.now()*0.01)*0.2;
                   f.rotation.y = f.userData.dir === 1 ? 0 : Math.PI;
                   if(f.position.x > 45 || f.position.x < 10) f.userData.dir *= -1;
                }
            });

            renderer.render(scene, camera);
        }

        // Start
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-overlay').style.display = 'none';
            if(currentStep > 0) location.reload();
            startMusic();
            animate();
            runSequence();
        });
        
        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>